<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Timemark Style Pro</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#a80000">
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body{
  margin:0;
  font-family:Arial;
  background:linear-gradient(135deg,#a80000,#ff6a00,#ffd54f);
  min-height:100vh;
}
.bg{position:fixed;inset:0;backdrop-filter:blur(6px);z-index:0}
.app{position:relative;z-index:2;max-width:520px;margin:auto;padding:10px}

.header{text-align:center;color:#fff}
.controls{
  background:rgba(255,255,255,.18);
  backdrop-filter:blur(14px);
  border-radius:18px;
  padding:12px;
  color:#fff;
  box-shadow:0 20px 40px rgba(0,0,0,.25)
}
input,button,label{
  width:100%;
  margin:4px 0;
  padding:8px;
  border-radius:10px;
  font-size:14px
}
button{cursor:pointer}
canvas{
  max-width:100%;
  margin-top:10px;
  border-radius:16px;
  background:#000
}

/* HOA R∆†I */
.petals{position:fixed;inset:0;pointer-events:none;z-index:1}
@keyframes fall{to{transform:translateY(120vh)}}
@keyframes sway{
  0%{margin-left:0}
  50%{margin-left:30px}
  100%{margin-left:0}
}

/* KH√ìA APP */
.lock{
  position:fixed;inset:0;
  background:rgba(0,0,0,.85);
  z-index:9999;
  display:flex;
  align-items:center;
  justify-content:center;
}
.lockBox{
  background:#fff;
  padding:20px;
  border-radius:14px;
  width:90%;
  max-width:360px;
  text-align:center;
}
.lockBox h3{margin-top:0}
</style>
</head>

<body>
<div class="bg"></div>
<div class="petals" id="petals"></div>

<!-- KHO√Å APP -->
<div class="lock" id="lock">
  <div class="lockBox">
    <h3>üîê K√≠ch ho·∫°t Timemark</h3>
    <input id="keyInput" placeholder="Nh·∫≠p key c·ªßa b·∫°n">
    <button onclick="activate()">K√≠ch ho·∫°t</button>
    <p style="font-size:12px;opacity:.7">
      1 key ch·ªâ d√πng cho 1 thi·∫øt b·ªã
    </p>
  </div>
</div>

<div class="app">
<header class="header">
  <h2>üìç Timemark ver2</h2>
  <p>üå∏ Ch√∫c m·ª´ng nƒÉm m·ªõi ‚Äì An khang ¬∑ Th·ªãnh v∆∞·ª£ng üå∏</p>
</header>

<div class="controls">
<label>·∫¢nh check-in</label>
<input type="file" id="imageInput" accept="image/*">

<label>Logo</label>
<input type="file" id="logoInput" accept="image/*">

<label>Gi·ªù</label>
<input id="time">
<label>Ng√†y</label>
<input id="date">
<label>Th·ª©</label>
<input id="weekday">
<label>ƒê·ªãa ch·ªâ</label>
<input id="address">

<button onclick="setNow()">‚è± L·∫•y gi·ªù</button>
<button onclick="draw()">üñä T·∫°o watermark</button>
<button onclick="download()">‚¨áÔ∏è T·∫£i ·∫£nh</button>
</div>

<canvas id="c"></canvas>
</div>

<script>
/* ===== CONFIG ===== */
const API_URL = "https://script.google.com/macros/s/AKfycbyv1mzcl0EBwbZD37slH9CJVn5tmz6wDbSi2Q_BcBxHAEkNJ8klJmoJvo78ag_NUI4oJQ/exec";

/* ===== DEVICE ID ===== */
function getDevice(){
  let d = localStorage.getItem("tm_device");
  if(!d){
    d = crypto.randomUUID();
    localStorage.setItem("tm_device",d);
  }
  return d;
}

/* ===== KI·ªÇM TRA K√çCH HO·∫†T ===== */
if(localStorage.getItem("tm_active")==="1"){
  document.getElementById("lock").style.display="none";
}

/* ===== K√çCH HO·∫†T ===== */
function activate(){
  const key = keyInput.value.trim();
  if(!key) return alert("Nh·∫≠p key");

  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      key:key,
      device:getDevice()
    })
  })
  .then(r=>r.json())
  .then(d=>{
    if(d.status==="ok"){
      localStorage.setItem("tm_active","1");
      alert("K√≠ch ho·∫°t th√†nh c√¥ng");
      location.reload();
    }else{
      alert(d.message || "Key kh√¥ng h·ª£p l·ªá");
    }
  })
  .catch(()=>{
    alert("Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c server");
  });
}

/* ===== APP CH√çNH ===== */
const c=document.getElementById("c");
const ctx=c.getContext("2d");
let img=new Image(), logo=new Image();

imageInput.onchange=e=>{
  const r=new FileReader();
  r.onload=()=>img.src=r.result;
  r.readAsDataURL(e.target.files[0]);
};
logoInput.onchange=e=>{
  const r=new FileReader();
  r.onload=()=>logo.src=r.result;
  r.readAsDataURL(e.target.files[0]);
};
img.onload=()=>{
  c.width=img.width;
  c.height=img.height;
  ctx.drawImage(img,0,0);
};

function setNow(){
  const d=new Date();
  time.value=d.toLocaleTimeString("vi-VN",{hour:"2-digit",minute:"2-digit"});
  date.value=d.toLocaleDateString("vi-VN",{day:"2-digit",month:"long",year:"numeric"});
  weekday.value=d.toLocaleDateString("vi-VN",{weekday:"long"});
}

function draw(){
  if(!img.src) return alert("Ch∆∞a c√≥ ·∫£nh");
  ctx.drawImage(img,0,0);
  ctx.fillStyle="#fff";
  ctx.font="30px Arial";
  ctx.fillText(time.value,20,c.height-80);
  ctx.font="22px Arial";
  ctx.fillText(date.value,20,c.height-40);
}

function download(){
  const a=document.createElement("a");
  a.href=c.toDataURL("image/png");
  a.download="timemark.png";
  a.click();
}

/* HOA R∆†I */
window.onload=()=>{
  const box=document.getElementById("petals");
  ["üå∏","üåº","üå∫"].forEach(()=>{
    for(let i=0;i<8;i++){
      const p=document.createElement("div");
      p.innerText="üå∏";
      p.style.position="absolute";
      p.style.left=Math.random()*100+"vw";
      p.style.top="-10%";
      p.style.animation=`fall ${10+Math.random()*10}s linear infinite,
                         sway ${3+Math.random()*4}s ease-in-out infinite`;
      box.appendChild(p);
    }
  });
};
</script>
</body>
</html>

