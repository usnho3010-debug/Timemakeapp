<!DOCTYPE html>

<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Timemark Style Pro</title>

<!-- ‚≠ê THEME T√ÅCH RI√äNG -->

<link rel="stylesheet" href="theme-app.css">

<!-- PWA -->

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#a80000">
<meta name="viewport" content="width=device-width,initial-scale=1">
</head>

<body>
<div class="bg"></div>
<div id="loadingBlur" class="loadingBlur"></div>
<div class="petals" id="petals"></div>

<!-- KHO√Å APP -->

<div class="lock" id="lock">
  <div class="lockBox">
    <h3>üîê K√≠ch ho·∫°t Timemark</h3>
    <input id="keyInput" placeholder="Nh·∫≠p key c·ªßa b·∫°n">
    <button id="btnActivate" onclick="activate()">K√≠ch ho·∫°t</button>



<button onclick="openBuyPage()" 
style="margin-top:6px;background:#ff6a00;color:#fff;font-weight:bold;">
üõí Mua key Timemark </button>
<p style="font-size:12px;">
  L∆ØU √ù: 1 key ch·ªâ d√πng cho 1 thi·∫øt b·ªã
</p>

  </div>
</div>

<!-- TH√îNG B√ÅO -->

<div class="lock" id="notifyBox" style="display:none;">
  <div class="lockBox notifyMax">
    <div class="shieldIcon">üõ°</div>
    <h3 id="notifyTitle"></h3>
    <p id="notifyMsg"></p>
    <div class="notifyActions">
  <button id="notifyBtn">B·∫Øt ƒë·∫ßu s·ª≠ d·ª•ng</button>
  <button id="notifyBtn2" style="display:none"></button>
</div>

  </div>
</div>

<div class="app">
<header class="header">
  <h2>üìç Timemark ver2</h2>
  <p>üå∏ Ch√∫c m·ª´ng nƒÉm m·ªõi ‚Äì An khang ¬∑ Th·ªãnh v∆∞·ª£ng üå∏</p>
</header>

<div class="controls">
<label>·∫¢nh check-in</label>
<input type="file" id="imageInput" accept="image/*">

<label>Logo</label> <input type="file" id="logoInput" accept="image/*">

<label>Gi·ªù</label> <input id="time"> <label>Ng√†y</label> <input id="date"> <label>Th·ª©</label> <input id="weekday"> <label>ƒê·ªãa ch·ªâ</label> <input id="address">

<button onclick="setNow()">‚è± L·∫•y gi·ªù</button> <button onclick="draw()">üñä T·∫°o watermark</button> <button onclick="download()">‚¨áÔ∏è T·∫£i ·∫£nh</button>

</div>

<canvas id="c"></canvas>

</div>

<script>
/* ===================================================
‚≠ê BI·∫æN TO√ÄN B·ªò alert() ‚Üí popup Timemark
KH√îNG c·∫ßn s·ª≠a logic c≈©
=================================================== */

const _nativeAlert = window.alert;

window.alert = function(message){

// n·∫øu popup notify ch∆∞a load th√¨ d√πng alert g·ªëc
if(!document.getElementById("notifyBox")){
_nativeAlert(message);
return;
}

// d√πng giao di·ªán notify m·ªõi
showNotify(
  "warning",
  "Th√¥ng b√°o",
  String(message)
);

};

/* ===== CONFIG ===== */
const API_URL = "https://script.google.com/macros/s/AKfycbwDRIc7_SZC2nx1TlYRU-taklWN57lDF9aXLHt2LE3MrLDEu-7Q0inQQlvYd6MKplhw9Q/exec";

let keyWatcher = null;

/* ===== DEVICE ID ===== */
function getDevice(){
  let d = localStorage.getItem("tm_device");
  if(!d){
    d = crypto.randomUUID();
    localStorage.setItem("tm_device",d);
  }
  return d;
}

/* ===== AUTO CHECK KEY ===== */
function autoCheckKey(){

  const savedKey = localStorage.getItem("tm_key");
  if(!savedKey) return;

  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      key: savedKey,
      device: getDevice()
    })
  })
  .then(r=>r.json())
  .then(d=>{

    console.log("AUTO CHECK:", d);
/* ===== B·∫¢O TR√å REALTIME ===== */
if(d.maintenance === true){

  localStorage.removeItem("tm_active");
  localStorage.removeItem("tm_key");

  document.getElementById("lock").style.display="flex";

  showNotify(
  "maintenance",
  "üõ† H·ªá th·ªëng b·∫£o tr√¨",
  "Timemark ƒëang ƒë∆∞·ª£c n√¢ng c·∫•p.\nVui l√≤ng quay l·∫°i sau √≠t ph√∫t."
);

}

   // ‚ùå key l·ªói / h·∫øt h·∫°n / b·ªã kh√≥a
if(d.status !== "ok"){

  localStorage.removeItem("tm_active");
  localStorage.removeItem("tm_key");

  localStorage.removeItem("tm_notify_once");

  document.getElementById("lock").style.display = "flex";

  showNotify(
  "keyError",
  "Th√¥ng b√°o h·ªá th·ªëng",
  d.message || "Key kh√¥ng h·ª£p l·ªá"
);

  return;
}

if(localStorage.getItem("tm_notify_once")==="1") return;
localStorage.setItem("tm_notify_once","1");

const level  = d.level || "--";
const expire = d.expireDate || "--";
const left   = d.daysLeft || "--";

showNotify(
  "üõ° Th√¥ng tin b·∫£n quy·ªÅn",
`üîë G√≥i: ${level}
üì¶ Th·ªùi h·∫°n: ${type}
üî• C√≤n l·∫°i: ${left} ng√†y
‚è≥ H·∫øt h·∫°n: ${expire}

üëâ Ch√∫c b·∫°n s·ª≠ d·ª•ng Timemark hi·ªáu qu·∫£`
);

})
.catch(()=>{
  console.log("Kh√¥ng check ƒë∆∞·ª£c key (offline)");
});
}

function startRealtimeCheck(){

  if(keyWatcher) return;

  autoCheckKey();

  keyWatcher = setInterval(()=>{
    autoCheckKey();
  },5000);

}

/* ===== K√çCH HO·∫†T ===== */
function activate(){

  const key = keyInput.value.trim();
  const btn = document.getElementById("btnActivate");

  if(!key){
    showNotify("Th√¥ng b√°o","Nh·∫≠p key");
    return;
  }

  btn.disabled = true;
  btn.innerText = "‚è≥ ƒêang ki·ªÉm tra...";
document.getElementById("loadingBlur").style.display = "block";

  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      key:key,
      device:getDevice()
    })
  })
  .then(r=>r.json())
  .then(d=>{

  console.log("API DATA:", d);

  if(d.status==="ok"){

  localStorage.setItem("tm_active","1");
  localStorage.setItem("tm_key", key);

  document.getElementById("lock").style.display="none";

  startRealtimeCheck();

  document.getElementById("loadingBlur").style.display="none";
  btn.disabled=false;
  btn.innerText="K√≠ch ho·∫°t";

    startConfetti();

    showNotify(
  "success",
  "üéâ K√≠ch ho·∫°t th√†nh c√¥ng!",

`üîë G√≥i: ${d.level} (${d.type})
üìÖ Ng√†y k√≠ch ho·∫°t: ${d.startDate}
‚è≥ H·∫øt h·∫°n: ${d.expireDate}
üî• C√≤n l·∫°i: ${d.daysLeft} ng√†y`
    );

  }else{

    document.getElementById("loadingBlur").style.display="none";
    btn.disabled=false;
    btn.innerText="K√≠ch ho·∫°t";

    showNotify(
"keyError",
"Th√¥ng b√°o h·ªá th·ªëng",
d.message || "Key kh√¥ng h·ª£p l·ªá"
);


  }

})
  .catch(()=>{
    btn.disabled = false;
    btn.innerText = "K√≠ch ho·∫°t";
    showNotify("L·ªói k·∫øt n·ªëi","Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c server");
  });
}

document.addEventListener("visibilitychange",()=>{
  if(!document.hidden){
    autoCheckKey();
  }
});

/* ===== TH√îNG B√ÅO UI ===== */
function showNotify(type,title,msg){

const box = document.getElementById("notifyBox");

/* ‚≠ê XO√Å S·∫†CH BUTTON C≈® ‚Üí TR√ÅNH K·∫∏T EVENT */
document.querySelector(".notifyActions").innerHTML = `     <button id="notifyBtn"></button>     <button id="notifyBtn2" style="display:none"></button>
  `;

const btn  = document.getElementById("notifyBtn");
const btn2 = document.getElementById("notifyBtn2");

document.getElementById("notifyTitle").innerText = title;
document.getElementById("notifyMsg").innerText   = msg;

box.style.display="flex";

/* ===== TYPE UX ===== */

if(type==="maintenance"){

btn.innerText="üè†V·ªÅ Trang ch·ªß";
btn.onclick=()=>window.location.href="https://timemark.io.vn";

/* ·∫®n n√∫t th·ª© 2 */
btn2.style.display="none";

}





else if(type==="keyError"){


btn.innerText="üè† Trang ch·ªß";
btn.onclick=()=>window.location.href="https://timemark.io.vn";

btn2.style.display="block";
btn2.innerText="üõí Mua key";
btn2.onclick=()=>window.open("buy.html","_blank");


}

else if(type==="success"){

btn.innerText="B·∫Øt ƒë·∫ßu s·ª≠ d·ª•ng";
btn.onclick=()=>closeNotify();


}

else{

btn.innerText="ƒê√≥ng";
btn.onclick=()=>closeNotify();

}

}



function closeNotify(){
  document.getElementById("notifyBox").style.display = "none";
}

/* ===== CONFETTI MAX ===== */
function startConfetti(){
  const box=document.getElementById("petals");

  for(let i=0;i<20;i++){
    const p=document.createElement("div");
    p.innerText="üéâ";
    p.style.position="fixed";
    p.style.left=Math.random()*100+"vw";
    p.style.top="-10px";
    p.style.zIndex="99999";
    p.style.animation=`fall ${4+Math.random()*4}s linear`;
    document.body.appendChild(p);

    setTimeout(()=>p.remove(),5000);
  }
}

/* ===== APP CH√çNH ===== */
const c=document.getElementById("c");
const ctx=c.getContext("2d");

function isOn(id){
 const el=document.getElementById(id);
 return el?el.checked:true;
}

let img=new Image();
let logo=new Image();

function fs(p){
 return Math.round(Math.min(c.width,c.height)*p);
}

function generateCode(len=12){
 const s="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
 return Array.from({length:len},()=>s[Math.random()*s.length|0]).join("");
}

function drawRoundedImage(ctx,img,x,y,w,h,r){
 ctx.save();
 ctx.beginPath();
 ctx.moveTo(x+r,y);
 ctx.lineTo(x+w-r,y);
 ctx.quadraticCurveTo(x+w,y,x+w,y+r);
 ctx.lineTo(x+w,y+h-r);
 ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
 ctx.lineTo(x+r,y+h);
 ctx.quadraticCurveTo(x,y+h,x,y+h-r);
 ctx.lineTo(x,y+r);
 ctx.quadraticCurveTo(x,y,x+r,y);
 ctx.closePath();
 ctx.clip();
 ctx.drawImage(img,x,y,w,h);
 ctx.restore();
}

function drawShield(ctx,x,y,size,color){
 ctx.save();
 ctx.translate(x,y);
 ctx.strokeStyle=color;
 ctx.lineWidth=size*0.08;
 ctx.lineCap="round";
 ctx.lineJoin="round";

 ctx.beginPath();
 ctx.moveTo(0,-size*0.45);
 ctx.lineTo(size*0.38,-size*0.25);
 ctx.lineTo(size*0.30,size*0.22);
 ctx.quadraticCurveTo(0,size*0.45,-size*0.30,size*0.22);
 ctx.lineTo(-size*0.38,-size*0.25);
 ctx.closePath();
 ctx.stroke();

 ctx.beginPath();
 ctx.moveTo(-size*0.14,size*0.02);
 ctx.lineTo(-size*0.02,size*0.14);
 ctx.lineTo(size*0.18,-size*0.10);
 ctx.stroke();

 ctx.restore();
}

imageInput.onchange=e=>{
 const r=new FileReader();
 r.onload=()=>img.src=r.result;
 r.readAsDataURL(e.target.files[0]);
};
logoInput.onchange=e=>{
 const r=new FileReader();
 r.onload=()=>logo.src=r.result;
 r.readAsDataURL(e.target.files[0]);
};

img.onload=()=>{
 c.width=img.width;
 c.height=img.height;
 ctx.drawImage(img,0,0);
};

function setNow(){
 const d=new Date();
 time.value=d.toLocaleTimeString("vi-VN",{hour:'2-digit',minute:'2-digit'});
 const day=String(d.getDate()).padStart(2,'0');
 const month=d.getMonth()+1;
 const year=d.getFullYear();
 date.value=`${day} th√°ng ${month}, ${year}`;
 weekday.value=d.toLocaleDateString("vi-VN",{weekday:'long'});
}

function getGPS(){
  if(!navigator.geolocation){
    alert("Thi·∫øt b·ªã kh√¥ng h·ªó tr·ª£ GPS");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    pos=>{
      const lat = pos.coords.latitude.toFixed(6);
      const lng = pos.coords.longitude.toFixed(6);

      alert("GPS OK: " + lat + ", " + lng);

      fetch(
        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`,
        { headers:{ "Accept":"application/json" } }
      )
        .then(r=>r.json())
        .then(data=>{
          if(data.address){
            const a = data.address;

            const xa =
              a.village || a.suburb || a.hamlet || a.town || "";

            const huyen =
              a.county || a.district || a.city || "";

            const tinh =
              a.state || a.region || "";

            address.value = [
              xa ? `X. ${xa}` : "",
              huyen ? `H. ${huyen}` : "",
              tinh
            ].filter(Boolean).join(", ");
          }else{
            address.value = `${lat}, ${lng}`;
          }
        })
        .catch(err=>{
          alert("Fetch l·ªói");
          address.value = `${lat}, ${lng}`;
        });
    },
    err=>{
      alert("Kh√¥ng l·∫•y ƒë∆∞·ª£c GPS: " + err.message);
    },
    {
      enableHighAccuracy:true,
      timeout:15000,
      maximumAge:0
    }
  );
}

function draw(){
 if(!img.src) return alert("Ch∆∞a ch·ªçn ·∫£nh");
 ctx.drawImage(img,0,0);

 const pad=fs(0.04);

 if(isOn("toggleVertical")){
  ctx.save();
  ctx.translate(c.width-fs(0.008),c.height/2);
  ctx.rotate(-Math.PI/2);

  const code=generateCode();
  const text=`${code}  Timemark Verified`;

  const fontSize = fs(0.018);
  ctx.font = `${fontSize}px Arial`;
  ctx.fillStyle = "rgba(255,255,255,0.9)";
  ctx.textAlign = "left";
  ctx.textBaseline = "middle";

  const w=ctx.measureText(text).width;

  drawShield(
    ctx,
    -w/2 - fs(0.02),
    0,
    fs(0.022),
    "#FFFFFF"
  );

  ctx.fillText(text,-w/2,0);
  ctx.restore();
 }

 if(isOn("toggleBrand")){
  let yBrand=c.height-pad;
  ctx.textAlign="right";
  ctx.font=`bold ${fs(0.028)}px Arial`;

  ctx.fillStyle="#FFFFFF";
  ctx.fillText("mark",c.width-pad,yBrand);
  const wMark=ctx.measureText("mark").width;

  ctx.fillStyle="#FFC107";
  ctx.fillText("Time",c.width-pad-wMark,yBrand);

  ctx.font=`${fs(0.018)}px Arial`;
  ctx.fillStyle="rgba(255,255,255,0.5)";
  ctx.fillText("100% Ch√¢n th·ª±c",c.width-pad,yBrand+fs(0.03));
 }

 ctx.textAlign="left";
 let leftX=pad;
 let y=c.height-pad-fs(0.09);

 if(logo.src && isOn("toggleLogo")){
  const lh=fs(0.085);
  const ratio=logo.width/logo.height;
  drawRoundedImage(ctx,logo,leftX,y-lh-fs(0.02),lh*ratio,lh,fs(0.012));
  y+=fs(0.02);
 }

 if(isOn("toggleTime")){
  ctx.font=`500 ${fs(0.045)}px Arial`;
  ctx.fillStyle="#FFFFFF";
  ctx.fillText(time.value,leftX,y+fs(0.015));

  const timeW=ctx.measureText(time.value).width;
  const lineX=leftX+timeW+fs(0.02);

  ctx.strokeStyle="#FFC107";
  ctx.lineWidth=fs(0.004);
  ctx.beginPath();
  ctx.moveTo(lineX,y-fs(0.028));
  ctx.lineTo(lineX,y+fs(0.028));
  ctx.stroke();

  ctx.font=`${fs(0.03)}px Arial`;
  ctx.fillText(date.value,lineX+fs(0.015),y-fs(0.01));
  ctx.fillText(weekday.value,lineX+fs(0.015),y+fs(0.03));
 }

 if(isOn("toggleAddress")){
  y+=fs(0.065);
  ctx.font=`${fs(0.028)}px Arial`;
  ctx.fillStyle="rgba(255,255,255,0.9)";
  ctx.fillText(address.value,leftX,y);
 }
}

function isIOS(){
 return /iPhone|iPad|iPod/i.test(navigator.userAgent);
}
function download(){
 if(!img.src) return;
 const d=c.toDataURL("image/png");
 if(isIOS()){
  const w=window.open();
  w.document.write(`<img src="${d}" style="width:100%"><p>Nh·∫•n gi·ªØ ·∫£nh ‚Üí L∆∞u</p>`);
 }else{
  const a=document.createElement("a");
  a.href=d;a.download="timemark.png";a.click();
 }
}
function openBuyPage(){
  window.open("buy.html","_blank");
}

window.onload=()=>{

  localStorage.removeItem("tm_notify_once");

  const box=document.getElementById("petals");

  ["üå∏","üåº","üå∫"].forEach(()=>{
    for(let i=0;i<8;i++){
      const p=document.createElement("div");
      p.innerText="üå∏";
      p.style.position="absolute";
      p.style.left=Math.random()*100+"vw";
      p.style.top="-10%";
      p.style.animation=`fall ${10+Math.random()*10}s linear infinite,
                         sway ${3+Math.random()*4}s ease-in-out infinite`;
      box.appendChild(p);
    }
  });

  if(localStorage.getItem("tm_active")==="1"){
    document.getElementById("lock").style.display="none";
    startRealtimeCheck();
  }

};
</script>
<!-- ===== TIMEMARK FLOATING MENU ===== -->
<div class="tmFab">
  <div class="tmFabMenu" id="tmFabMenu">
    <a href="https://timemark.io.vn" class="tmFabItem">üè† <span>Trang ch·ªß</span></a>
    <a href="buy.html" target="_blank" class="tmFabItem">üõí <span>Mua key</span></a>
    <a href="https://zalo.me/0837685798" target="_blank" class="tmFabItem">üí¨ <span>Li√™n h·ªá</span></a>
  </div>

  <button id="tmFabBtn" class="tmFabBtn" onclick="toggleFab()">‚ò∞</button>

</div>

<script>
function toggleFab(){
  document.getElementById("tmFabMenu").classList.toggle("show");
}
const fab = document.getElementById("tmFabBtn");
const fabWrap = document.querySelector(".tmFab");

let isDragging = false;
let offsetX = 0;
let offsetY = 0;

fab.addEventListener("pointerdown",(e)=>{
  isDragging = true;
  offsetX = e.clientX - fabWrap.getBoundingClientRect().left;
  offsetY = e.clientY - fabWrap.getBoundingClientRect().top;
  fab.setPointerCapture(e.pointerId);
});

document.addEventListener("pointermove",(e)=>{
  if(!isDragging) return;

  fabWrap.style.right = "auto";
  fabWrap.style.bottom = "auto";
  fabWrap.style.left = (e.clientX - offsetX) + "px";
  fabWrap.style.top  = (e.clientY - offsetY) + "px";
});

document.addEventListener("pointerup",()=>{
  isDragging=false;
});
</script>

</body>
</html>
